<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDNIGHT SHELL SWIRL</title>
    <style>
        :root {
            --gold: #f1c40f;
            --gold-glow: rgba(241, 196, 15, 0.6);
            --magic-purple: #8e44ad;
            --bg-dark: #050410;
            --dynamic-hue: 0deg;
            --mouse-x: 50%;
            --mouse-y: 50%;
            --fever-color: #f1c40f;
        }

        /* Fever Mode Animations */
        @keyframes feverGlow {
            0%, 100% { box-shadow: 0 0 20px var(--fever-color), 0 0 40px var(--fever-color), 0 0 60px var(--fever-color); }
            50% { box-shadow: 0 0 40px var(--fever-color), 0 0 80px var(--fever-color), 0 0 120px var(--fever-color); }
        }

        @keyframes sparkle {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }

        @keyframes trailEffect {
            0% { opacity: 0.8; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(0.5); }
        }

        .fever-mode {
            animation: feverGlow 1s ease-in-out infinite !important;
            border-color: var(--fever-color) !important;
            filter: brightness(1.3) !important;
        }

        .fever-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--fever-color);
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 0.6s ease-out forwards;
            z-index: 100;
        }

        .cup-trail {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            background: radial-gradient(circle, var(--fever-color) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            animation: trailEffect 0.5s ease-out forwards;
        }

        @keyframes rotateGlow {
            0% { rotate: 0deg; }
            100% { rotate: 360deg; }
        }

        @keyframes hueShift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-8px, 2px); }
            20% { transform: translate(8px, -2px); }
            30% { transform: translate(-8px, -2px); }
            40% { transform: translate(8px, 2px); }
            50% { transform: translate(-8px, 2px); }
            60% { transform: translate(8px, -2px); }
            70% { transform: translate(-4px, 2px); }
            80% { transform: translate(4px, -2px); }
            90% { transform: translate(-2px, 1px); }
        }

        @keyframes slideInFromLeft {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutToLeft {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        @keyframes slideInCenter {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes slideOutCenter {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes zoomInCenter {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes zoomOutCenter {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0.8);
                opacity: 0;
            }
        }

        .slide-in {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .slide-out {
            animation: slideOutToLeft 0.5s ease-in;
        }

        .slide-in-center {
            animation: slideInCenter 0.4s ease-out forwards;
        }

        .slide-out-center {
            animation: slideOutCenter 0.3s ease-in forwards;
        }

        .zoom-in-center {
            animation: zoomInCenter 0.4s ease-out forwards;
        }

        .zoom-out-center {
            animation: zoomOutCenter 0.3s ease-in forwards;
        }

        .screen-shake {
            animation: screenShake 0.5s ease-in-out;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2C5F8D 0%, #1E3A5F 100%);
            color: #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Snow Animation */
        .snowflake {
            position: fixed;
            top: -10px;
            z-index: 1;
            color: white;
            font-size: 1.2em;
            opacity: 0.4;
            pointer-events: none;
            animation: fall linear infinite;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.4);
        }

        @keyframes fall {
            0% {
                top: -10%;
                opacity: 0.5;
            }
            100% {
                top: 110%;
                opacity: 0;
            }
        }

        .snowflake:nth-child(1) { left: 10%; animation-duration: 10s; animation-delay: 0s; font-size: 1em; }
        .snowflake:nth-child(2) { left: 20%; animation-duration: 12s; animation-delay: 2s; font-size: 1.3em; }
        .snowflake:nth-child(3) { left: 30%; animation-duration: 8s; animation-delay: 4s; font-size: 0.9em; }
        .snowflake:nth-child(4) { left: 40%; animation-duration: 14s; animation-delay: 1s; font-size: 1.4em; }
        .snowflake:nth-child(5) { left: 50%; animation-duration: 11s; animation-delay: 3s; font-size: 1.1em; }
        .snowflake:nth-child(6) { left: 60%; animation-duration: 9s; animation-delay: 5s; font-size: 1.2em; }
        .snowflake:nth-child(7) { left: 70%; animation-duration: 13s; animation-delay: 2.5s; font-size: 1em; }
        .snowflake:nth-child(8) { left: 80%; animation-duration: 10.5s; animation-delay: 4.5s; font-size: 1.3em; }
        .snowflake:nth-child(9) { left: 90%; animation-duration: 12.5s; animation-delay: 1.5s; font-size: 1.1em; }
        .snowflake:nth-child(10) { left: 15%; animation-duration: 11.5s; animation-delay: 3.5s; font-size: 1.1em; }
        .snowflake:nth-child(11) { left: 25%; animation-duration: 9.5s; animation-delay: 0.5s; font-size: 1.3em; }
        .snowflake:nth-child(12) { left: 35%; animation-duration: 13.5s; animation-delay: 2.8s; font-size: 0.9em; }
        .snowflake:nth-child(13) { left: 45%; animation-duration: 10.8s; animation-delay: 4.2s; font-size: 1.2em; }
        .snowflake:nth-child(14) { left: 55%; animation-duration: 12.2s; animation-delay: 1.8s; font-size: 1.4em; }
        .snowflake:nth-child(15) { left: 65%; animation-duration: 8.5s; animation-delay: 3.2s; font-size: 1em; }
        .snowflake:nth-child(16) { left: 75%; animation-duration: 14.5s; animation-delay: 5.5s; font-size: 1.3em; }
        .snowflake:nth-child(17) { left: 85%; animation-duration: 11.2s; animation-delay: 0.8s; font-size: 1.1em; }
        .snowflake:nth-child(18) { left: 95%; animation-duration: 9.8s; animation-delay: 4.8s; font-size: 1.1em; }
        .snowflake:nth-child(19) { left: 5%; animation-duration: 13.2s; animation-delay: 2.2s; font-size: 1.3em; }
        .snowflake:nth-child(20) { left: 22%; animation-duration: 10.2s; animation-delay: 3.8s; font-size: 0.9em; }

        .main-card {
            background: rgba(135, 206, 235, 0.95);
            border: 8px solid transparent;
            border-radius: 30px;
            width: 95%;
            max-width: 1100px; 
            height: 95vh;
            max-height: 95vh;
            padding: 20px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-sizing: border-box;
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .main-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 30px;
            pointer-events: none;
            z-index: 10;
        }
        
        .border-svg {
            position: absolute;
            inset: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 10px);
            pointer-events: none;
            z-index: 10;
        }
        
        .border-svg rect {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 200 800;
            animation: dashRun 4s linear infinite;
        }
        
        @keyframes dashRun {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -1000; }
        }

        .main-card::after {
            content: '';
            position: absolute;
            inset: 4px;
            background: rgba(135, 206, 235, 0.95);
            border-radius: 28px;
            z-index: -1;
        }

        .main-card:hover {
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
        }

        /* Menu UI */
        .top-nav { position: absolute; top: 25px; right: 25px; z-index: 1000; }
        .menu-trigger {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--gold);
            color: var(--gold);
            z-index: 2;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 900;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            animation: hueShift 10s linear infinite;
        }

        .menu-trigger:hover {
            background: rgba(0, 0, 0, 0.7);
            box-shadow: 0 0 20px var(--gold-glow), 0 0 35px var(--gold-glow);
            transform: scale(1.1);
            border-color: var(--gold);
        }

        .menu-bar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: transparent;
            border: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0;
            transition: transform 0.4s ease-out, opacity 0.3s ease;
            z-index: 9999;
            opacity: 0;
        }

        .menu-bar::before {
            content: none;
        }

        .menu-bar.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .menu-bar.show button {
            animation: slideInFromCenter 0.4s ease-out forwards;
        }

        .menu-bar.show button:nth-child(1) {
            animation-delay: 0s;
        }

        .menu-bar.show button:nth-child(2) {
            animation-delay: 0.1s;
        }

        .menu-bar.show button:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        .menu-bar.show button:nth-child(4) {
            animation-delay: 0.3s;
        }

        @keyframes slideInFromCenter {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .menu-bar button {
            width: 70px;
            height: 70px;
            padding: 0;
            background: rgba(15, 12, 41, 0.85);
            border: 2px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            font-weight: 800;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transform: scale(0);
            opacity: 0;
        }

        .menu-bar button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--gold);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            z-index: -1;
        }

        .menu-bar button:hover::before {
            width: 100px;
            height: 100px;
        }

        .menu-bar button:hover {
            color: #000;
            background: rgba(241, 196, 15, 0.2);
            box-shadow: 0 0 25px var(--gold-glow), 0 0 40px var(--gold-glow);
            transform: scale(1.15);
            border-color: var(--gold);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            z-index: 9998;
            backdrop-filter: blur(5px);
        }

        .menu-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Game Area Spacing */
        #game-area {
            width: 100%;
            max-height: 100%;
            display: flex;
            justify-content: center; 
            align-items: center; 
            padding: 15px 25px;
            gap: 195px;
            overflow: visible;
        }

        .cup-slot {
            position: relative;
            width: 140px; 
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            transition: transform 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95);
        }

        /* Cup Design matches the Image */
        .cup {
            width: 100px; 
            height: 140px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Bullet shape: Top is a perfect semi-circle */
            border-radius: 80px 80px 12px 12px;
            border: 1px solid rgba(15, 23, 42, 0.9);
            cursor: pointer;
            z-index: 10;
            position: relative;
            /* Base rim effect from image */
            box-shadow: 0 4px 0px -2px rgba(15, 23, 42, 0.7), 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: transform 0s, box-shadow 0.3s ease, border 0.3s ease, background 0.3s ease;
        }

        .cup:hover {
            transform: scale(1.08);
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 0 25px var(--gold-glow), 0 0 45px var(--gold-glow), 0 4px 0px -2px rgba(15, 23, 42, 0.9), 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            border: 1px solid rgba(15, 23, 42, 1);
        }

        .cup:hover::after {
            box-shadow: 0 0 25px var(--gold-glow), 0 0 40px var(--gold);
        }

        /* The Gold Band from the image */
        .cup::after {
            content: '';
            position: absolute; 
            top: 45%; 
            left: -5%;
            width: 110%; 
            height: 6px;
            background: var(--gold);
            box-shadow: 0 0 15px var(--gold-glow);
            z-index: 11;
        }

        .ball {
            width: 40px; height: 40px;
            background: radial-gradient(circle at 30% 30%, #fff, #999);
            border-radius: 50%;
            position: absolute;
            bottom: 10px;
            opacity: 0;
            z-index: 1;
        }

        .lift { 
            transform: translateY(-120px) !important; 
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            animation-delay: 0s !important;
            z-index: 100 !important;
        }
        .lift-high { 
            transform: translateY(-150px) !important; 
            transition: transform 0.6s ease-out !important; 
            animation-delay: 0s !important;
            z-index: 100 !important;
        }
        .slam { 
            transform: translateY(0) !important; 
            transition: transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important; 
        }
        .visible { 
            opacity: 1; 
            transition: opacity 0.3s ease;
        }

        /* Buttons */
        .btn-gold {
            background: linear-gradient(135deg, rgba(15, 52, 96, 0.4), rgba(15, 52, 96, 0.6)), var(--gold);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #000;
            border: 3px solid rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 10px 30px;
            font-size: 0.95rem;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 0 15px var(--gold-glow);
            margin: 4px 8px;
            width: 260px;
            transition: all 0.3s ease;
            animation: hueShift 10s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 48px;
        }

        .btn-gold:hover {
            background-color: #f9d849;
            box-shadow: 0 0 30px var(--gold-glow), 0 0 50px var(--gold-glow), 0 0 70px rgba(241, 196, 15, 0.4);
            transform: translateY(-3px) scale(1.05);
            filter: brightness(1.2);
        }

        .btn-gold.selected {
            background: linear-gradient(135deg, #f9d849, var(--gold));
            box-shadow: 0 0 25px var(--gold-glow), 0 0 45px var(--gold-glow), inset 0 0 20px rgba(0, 0, 0, 0.3);
            transform: scale(1.08);
            border: 2px solid #fff;
        }

        .btn-gold:disabled {
            background-color: #666;
            color: #333;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
            animation: none;
        }

        .btn-gold:disabled:hover {
            transform: none;
            filter: none;
            box-shadow: none;
        }

        .difficulty-info {
            font-size: 0.75rem;
            margin-top: 4px;
            opacity: 0.8;
            font-weight: 600;
        }

        .current-difficulty {
            border: 3px solid rgba(0, 0, 0, 0.4);
            padding: 8px 20px;
            border-radius: 10px;
            margin-top: 0;
            font-size: 0.9rem;
            text-align: center;
            background: rgba(241, 196, 15, 0.1);
            animation: hueShift 10s linear infinite;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .current-difficulty span {
            color: var(--gold);
            font-weight: bold;
            text-transform: uppercase;
        }

        .back-btn {
            position: absolute; top: 25px; left: 25px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid var(--gold);
            color: var(--gold); padding: 10px 24px; border-radius: 10px; cursor: pointer;
            transition: all 0.3s ease;
            animation: hueShift 10s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .back-btn:hover {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 20px var(--gold-glow), 0 0 40px var(--gold-glow);
            transform: scale(1.1);
        }

        .screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            height: 100%;
            justify-content: center;
            overflow: hidden;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .game-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-height: 100%;
        }
        
        .game-area-container {
            flex: 0 0 60%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            overflow: visible;
            padding: 0 0 40px 0;
        }
        
        .game-controls {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            padding-top: 4px;
            gap: 4px;
        }
        
        .game-buttons-row {
            display: flex;
            flex-direction: row;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .active { 
            display: flex; 
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            padding: 15px;
        }
        
        .label-header { 
            background: linear-gradient(
                90deg,
                #ff3399,
                #ff3333,
                #ff9933,
                #ffff33,
                #99ff33,
                #33ff33,
                #33ff99,
                #33ffff,
                #3399ff,
                #3333ff,
                #9933ff,
                #ff33ff,
                #ff3399
            );
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px; 
            margin-bottom: 15px; 
            font-size: 1.6rem; 
            font-weight: bold; 
            animation: flowingRainbow 4s linear infinite;
        }
        
        @keyframes flowingRainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }
        
        .multiplayer-scores {
            display: flex;
            gap: 12px;
            margin-top: 0;
            flex-wrap: nowrap;
            justify-content: center;
        }
        
        .p-score {
            border: 3px solid rgba(0, 0, 0, 0.4);
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: all 0.3s ease;
            animation: hueShift 10s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .p-score:hover {
            opacity: 0.8;
            box-shadow: 0 0 15px var(--gold-glow);
            transform: scale(1.05);
        }
        
        .p-score.active-turn {
            opacity: 1;
            background: rgba(241, 196, 15, 0.2);
            border-width: 3px;
            transform: scale(1.1);
        }

        .p-score.active-turn:hover {
            box-shadow: 0 0 20px var(--gold-glow), 0 0 35px var(--gold-glow);
            transform: scale(1.15);
        }

        .game-dashboard { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 4px;
            gap: 4px;
        }
        
        .score-difficulty-row {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            margin-bottom: 0;
        }

        /* Name Input Screen */
        .name-input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 650px;
            align-items: center;
            padding: 15px;
        }

        .shared-avatar-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 600px;
            align-items: center;
        }

        .all-players-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
        }
        
        .player-back-plate {
            background: rgba(15, 52, 96, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(241, 196, 15, 0.2);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .player-back-plate:hover {
            background: rgba(15, 52, 96, 0.25);
            border-color: rgba(241, 196, 15, 0.4);
        }

        .name-input-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.4s ease;
            box-sizing: border-box;
        }

        .name-input-wrapper.completed {
            border-color: rgba(46, 204, 113, 0.6);
            background: rgba(46, 204, 113, 0.1);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }

        .name-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .name-input-field {
            flex: 1;
            min-width: 0;
        }

        .name-input-label {
            color: #2d2d2d;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .name-input {
            width: 100%;
            padding: 11px 15px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #2d2d2d;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            line-height: normal;
            display: block;
            box-sizing: border-box;
            vertical-align: middle;
            margin: 0;
        }

        .name-input:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: scale(1.02);
        }

        .name-input.error {
            border-color: #ff4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .name-input-container.shake {
            animation: shake 0.5s;
        }
        
        .btn-gold.error-btn {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%) !important;
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4), 0 0 30px rgba(255, 68, 68, 0.3) !important;
            border-color: #ff6666 !important;
        }

        .name-input::placeholder {
            color: rgba(45, 45, 45, 0.4);
        }

        /* Avatar Selection */
        .avatar-selection-area {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
        }

        .avatar-categories {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
        }

        .category-btn {
            padding: 7px 10px;
            background: rgba(15, 12, 41, 0.8);
            border: 2px solid var(--gold);
            border-radius: 10px;
            color: var(--gold);
            font-weight: 700;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-btn:hover {
            background: rgba(241, 196, 15, 0.1);
            box-shadow: 0 0 15px var(--gold-glow);
            transform: scale(1.05);
        }

        .category-btn.active {
            background: rgba(241, 196, 15, 0.2);
            box-shadow: 0 0 20px var(--gold-glow);
            border-width: 3px;
        }

        .avatar-selector {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
            justify-items: center;
            width: 100%;
            max-width: 250px;
        }

        .avatar-selector.visible {
            display: grid;
        }

        .shared-avatar-selector-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 600px;
            align-items: center;
        }

        .avatar-option {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.8rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .avatar-option:hover {
            transform: scale(1.15);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.3);
        }

        .avatar-option.selected {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.35);
        }

        .avatar-display {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: rgba(15, 12, 41, 0.9);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
            flex-shrink: 0;
            transition: all 0.4s ease;
        }

        .avatar-display.completed {
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
        }

        .gemini-box { 
            border: 3px solid rgba(0, 0, 0, 0.5); 
            padding: 8px 20px; 
            border-radius: 10px; 
            margin-top: 12px;
            transition: all 0.3s ease;
            animation: hueShift 10s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-box:hover {
            box-shadow: 0 0 20px rgba(142, 68, 173, 0.5), 0 0 40px rgba(142, 68, 173, 0.3);
            border-color: #a569bd;
            transform: scale(1.02);
        }
        
        /* Credits */
        .credits {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            text-align: center;
            z-index: 100;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        .credits span {
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body>
    <!-- Snow Animation -->
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>
    <div class="snowflake">‚ùÜ</div>
    <div class="snowflake">‚ùÑ</div>
    <div class="snowflake">‚ùÖ</div>

    <div class="main-card">
        <svg class="border-svg" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="borderGradient">
                    <stop offset="0%" stop-color="#ff0080">
                        <animate attributeName="stop-color" values="#ff0080;#ff4500;#ffd700;#00ff00;#00ffff;#0080ff;#8000ff;#ff0080" dur="4s" repeatCount="indefinite" />
                    </stop>
                </linearGradient>
            </defs>
            <rect id="borderRect" x="5" y="5" width="calc(100% - 10)" height="calc(100% - 10)" rx="30" ry="30" stroke="url(#borderGradient)" stroke-width="10" fill="none" style="stroke-dashoffset: 0;" />
        </svg>
        <div id="splash-screen" class="screen active" style="justify-content: center; height: 100%;">
            <h1 style="font-size: 3rem; font-weight: 900; font-family: 'Arial Black', 'Helvetica', sans-serif; text-align: center; margin-bottom: 25px; background: linear-gradient(90deg, #ff0000, #ff7700, #ffff00, #00ff00, #0099ff, #9933ff, #ff0000); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: hueShift 10s linear infinite; letter-spacing: 2px; text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);">MIDNIGHT SHELL SWIRL</h1>
            <button class="btn-gold" onclick="showScreen('lang-screen')">ENTER THE GAME</button>
            <div class="credits">
                Developed by <span>ÁôΩÊº¢Â®ú - HANNAH KEZIA BARGAMENTO</span>
            </div>
        </div>

        <div id="lang-screen" class="screen">
            <button class="back-btn" onclick="showScreen('splash-screen')">¬´</button>
            <div class="label-header">LANGUAGE</div>
            <div class="button-container">
                <button class="btn-gold" onclick="setLanguage('en')">ENGLISH</button>
                <button class="btn-gold" onclick="setLanguage('zh')">ÁπÅÈ´î‰∏≠Êñá</button>
            </div>
        </div>

        <div id="player-screen" class="screen">
            <button class="back-btn" onclick="showScreen('lang-screen')">¬´</button>
            <div class="label-header">SELECT PLAYERS</div>
            <div class="button-container">
                <button class="btn-gold" onclick="setPlayers(1)">SOLO (P1)</button>
                <button class="btn-gold" onclick="setPlayers(2)">2 PLAYERS</button>
                <button class="btn-gold" onclick="setPlayers(3)">3 PLAYERS</button>
                <button class="btn-gold" onclick="setPlayers(4)">4 PLAYERS</button>
            </div>
        </div>

        <div id="name-screen" class="screen">
            <button class="back-btn" onclick="showScreen('player-screen')">¬´</button>
            <div class="label-header">WHO IS PLAYING</div>
            <div class="name-input-container" id="nameInputContainer">
                <!-- Name inputs will be dynamically added here -->
            </div>
            <button class="btn-gold" onclick="submitNames()" style="margin-top: 15px;">CONTINUE</button>
        </div>

        <div id="diff-screen" class="screen">
            <button class="back-btn" onclick="showScreen('player-screen')">¬´</button>
            <div class="label-header">DIFFICULTY</div>
            <button class="btn-gold diff-btn" data-difficulty="easy" onclick="selectDifficulty('easy')">
                EASY
                <div class="difficulty-info">Slow Speed</div>
            </button>
            <button class="btn-gold diff-btn" data-difficulty="medium" onclick="selectDifficulty('medium')">
                MEDIUM
                <div class="difficulty-info">Medium Speed</div>
            </button>
            <button class="btn-gold diff-btn" data-difficulty="hard" onclick="selectDifficulty('hard')">
                HARD
                <div class="difficulty-info">Fast Speed</div>
            </button>
            <button class="btn-gold diff-btn" data-difficulty="extreme" onclick="selectDifficulty('extreme')">
                EXTREME
                <div class="difficulty-info">Very Fast</div>
            </button>
            <button class="btn-gold diff-btn" data-difficulty="adaptive" onclick="selectDifficulty('adaptive')">
                ADAPTIVE
                <div class="difficulty-info">Adjusts to Your Skill</div>
            </button>
        </div>

        <div id="game-screen" class="screen">
            <div class="top-nav">
                <button class="menu-trigger" onclick="toggleMenu()">‚ò∞</button>
            </div>
            <div class="menu-overlay" id="menuOverlay"></div>
            <div id="menuBar" class="menu-bar">
                <button id="menu-pause-btn" onclick="handlePause()">‚è∏Ô∏è</button>
                <button id="menu-resume-btn" onclick="handleResume()" style="display: none;">‚ñ∂Ô∏è</button>
                <button onclick="handleRestart()">üîÑ</button>
                <button onclick="handleHome()">üè†</button>
            </div>

            <div class="game-content">
                <div class="game-area-container">
                    <div id="game-area"></div>
                </div>

                <div class="game-controls">
                    <div class="game-buttons-row">
                        <button id="footer-start-btn" class="btn-gold" onclick="playGame()">START SHUFFLE</button>
                        <button id="footer-restart-btn" class="btn-gold" onclick="restartAfterFail()" style="display: none;">RESTART</button>
                    </div>

                    <div class="game-dashboard">
                        <div class="score-difficulty-row">
                            <div id="player-indicators" class="multiplayer-scores"></div>
                            <div id="streak-display" class="p-score streak-display"></div>
                            <div class="current-difficulty" id="diff-display"></div>
                        </div>
                        <div class="gemini-box">‚ú® ‚ôä <span id="gemini-msg">"Focus your mind."</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Track mouse movement for dynamic color changes
        document.addEventListener('mousemove', (e) => {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            const hue = Math.floor((x * 360 + y * 180) % 360);
            document.documentElement.style.setProperty('--dynamic-hue', hue + 'deg');
            document.documentElement.style.setProperty('--mouse-x', (x * 100) + '%');
            document.documentElement.style.setProperty('--mouse-y', (y * 100) + '%');
            
            // Update SVG border based on mouse position - dramatic color shifts
            const borderRect = document.getElementById('borderRect');
            if (borderRect) {
                const opacity = 0.8 + (y * 0.2); // Opacity from 0.8 to 1
                const hueRotate = x * 720; // Double rotation for more color variety
                const saturation = 120 + (y * 80); // Higher saturation
                const brightness = 1.1 + (Math.abs(0.5 - y) * 0.4); // Brightness peaks in middle
                borderRect.style.opacity = opacity;
                borderRect.style.filter = `hue-rotate(${hueRotate}deg) brightness(${brightness}) saturate(${saturation}%)`;
            }
        });
        
        // Set SVG rect dimensions after load
        window.addEventListener('load', () => {
            const borderRect = document.getElementById('borderRect');
            const borderSvg = document.querySelector('.border-svg');
            if (borderRect && borderSvg) {
                const width = borderSvg.clientWidth - 8;
                const height = borderSvg.clientHeight - 8;
                borderRect.setAttribute('width', width);
                borderRect.setAttribute('height', height);
            }
        });

        let state = { 
            mapping: [], isBusy: false, isPaused: false,
            playerCount: 1, currentPlayer: 0, scores: [0,0,0,0],
            playerNames: ['Player 1', 'Player 2', 'Player 3', 'Player 4'],
            playerAvatars: ['üë§', 'üë•', 'üë∂', 'üë®'],
            numCups: 3, difficulty: null, gameActive: false,
            language: 'en', difficultySelected: false,
            // Fever Mode tracking
            consecutiveWins: 0, highestStreak: 0, feverMode: false, scoreMultiplier: 1
        };

        // Funny and Motivational Gemini Messages
        const geminiMessages = [
            "‚ú® Trust your instincts, they're rarely wrong!",
            "üéØ Focus like a laser beam!",
            "üß† Your brain is sharper than you think!",
            "üí™ Champions are made in moments like these!",
            "üîÆ The cup doesn't lie... but it does shuffle!",
            "‚ö° Lightning reflexes = Lightning results!",
            "üé™ Life's a circus, but you're the ringmaster!",
            "üåü Every expert was once a beginner!",
            "üé≤ Calculated risks lead to epic wins!",
            "üßò Zen mode: Activated!",
            "üöÄ To the moon and beyond!",
            "üèÜ Victory loves preparation!",
            "üëÅÔ∏è Eyes on the prize, mind on the game!",
            "üî• You're on fire! (Not literally though)",
            "üíé Pressure makes diamonds!",
            "üéØ Aim high, guess higher!",
            "üåà After confusion comes clarity!",
            "‚è∞ It's clutch o'clock!",
            "üß© Solving puzzles is your superpower!",
            "üé≠ Plot twist: You're actually good at this!",
            "‚òï Coffee is optional, winning is not!",
            "üå™Ô∏è Chaos is just another word for opportunity!",
            "üé∏ Rock and roll with it!",
            "üçÄ Make your own luck!",
            "ü¶Ö Eagle eyes never miss!",
            "üí° Brilliant minds think... and win!",
            "üåä Go with the flow, catch the ball!",
            "üé® This is your masterpiece in motion!",
            "üîî Ring the bell of success!",
            "üåô Moon's watching, show it what you got!"
        ];

        function getRandomGeminiMessage() {
            return geminiMessages[Math.floor(Math.random() * geminiMessages.length)];
        }

        // Fever Mode Functions
        function activateFeverMode() {
            state.feverMode = true;
            state.scoreMultiplier = 2;
            const feverColors = ['#FFD700', '#00FFFF', '#FF1493']; // Gold, Cyan, Hot Pink
            const feverColor = feverColors[Math.floor(Math.random() * feverColors.length)];
            document.documentElement.style.setProperty('--fever-color', feverColor);
            document.querySelector('.main-card').classList.add('fever-mode');
            document.getElementById('gemini-msg').innerText = 'üî• FEVER MODE! DOUBLE POINTS! üî•';
        }

        function deactivateFeverMode() {
            state.feverMode = false;
            state.scoreMultiplier = 1;
            document.querySelector('.main-card').classList.remove('fever-mode');
        }

        function createFeverParticles(element) {
            if (!state.feverMode) return;
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'fever-particle';
                const rect = element.getBoundingClientRect();
                particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }

        function addCupTrail(cupElement) {
            if (!state.feverMode) return;
            const trail = document.createElement('div');
            trail.className = 'cup-trail';
            cupElement.appendChild(trail);
            setTimeout(() => trail.remove(), 500);
        }

        const difficultySettings = {
            easy: { rounds: 8, interval: 700, complexChance: 0, ballChance: 0.3, label: 'Easy', desc: 'Slow Speed' },
            medium: { rounds: 8, interval: 450, complexChance: 0.2, ballChance: 0.5, label: 'Medium', desc: 'Medium Speed' },
            hard: { rounds: 10, interval: 300, complexChance: 0.4, ballChance: 0.7, label: 'Hard', desc: 'Fast Speed' },
            extreme: { rounds: 10, interval: 180, complexChance: 0.6, ballChance: 0.85, label: 'Extreme', desc: 'Very Fast' },
            adaptive: { rounds: 8, interval: 500, complexChance: 0.3, ballChance: 0.5, label: 'Adaptive', desc: 'Adjusts to Your Skill' }
        };

        const translations = {
            en: {
                title: 'MIDNIGHT SHELL SWIRL',
                enterGame: 'ENTER THE GAME',
                language: 'LANGUAGE',
                english: 'ENGLISH',
                chinese: 'ÁπÅÈ´î‰∏≠Êñá',
                selectPlayers: 'SELECT PLAYERS',
                solo: 'SOLO (P1)',
                players2: '2 PLAYERS',
                players3: '3 PLAYERS',
                players4: '4 PLAYERS',
                enterNames: 'WHO IS PLAYING',
                playerName: 'Player {n} Name',
                playerPlaceholder: 'Player {n}',
                playerDefault: 'Player {n}',
                continue: 'CONTINUE',
                difficulty: 'DIFFICULTY',
                difficultyLabel: 'Difficulty',
                easy: 'EASY',
                medium: 'MEDIUM',
                hard: 'HARD',
                extreme: 'EXTREME',
                adaptive: 'ADAPTIVE',
                menu: '‚ò∞',
                pause: '‚è∏Ô∏è Pause',
                resume: '‚ñ∂Ô∏è Resume',
                replay: 'üîÑ Restart',
                home: 'üè† Home',
                startShuffle: 'START SHUFFLE',
                focusMind: '"Focus your mind."',
                back: '¬´',
                turnWatch: "P{n}'s turn to watch!",
                focus: 'P{n} focus...',
                pickCup: 'P{n}, pick your cup!',
                gotIt: 'P{n} Got it!',
                missed: 'P{n} Missed!',
                ready: "P{n}'s turn. Ready?",
                restart: 'RESTART',
                avatarLabel: 'Avatar',
                animals: 'Animals',
                elements: 'Elements',
                anime: 'Anime',
                streak: 'Streak',
                highestStreak: 'Best'
            },
            zh: {
                title: 'Á•ûÁßòË≤ùÊÆºÊ¥óÁâå',
                enterGame: 'ÈÄ≤ÂÖ•ÈÅäÊà≤',
                language: 'Ë™ûË®Ä',
                english: 'ENGLISH',
                chinese: 'ÁπÅÈ´î‰∏≠Êñá',
                selectPlayers: 'ÈÅ∏ÊìáÁé©ÂÆ∂',
                solo: 'ÂñÆ‰∫∫ (P1)',
                players2: '2‰ΩçÁé©ÂÆ∂',
                players3: '3‰ΩçÁé©ÂÆ∂',
                players4: '4‰ΩçÁé©ÂÆ∂',
                enterNames: 'Ë™∞Âú®Áé©',
                playerName: 'Áé©ÂÆ∂ {n} ÂêçÁ®±',
                playerPlaceholder: 'Áé©ÂÆ∂ {n}',
                playerDefault: 'Áé©ÂÆ∂ {n}',
                continue: 'ÁπºÁ∫å',
                difficulty: 'Èõ£Â∫¶',
                difficultyLabel: 'Èõ£Â∫¶',
                easy: 'Á∞°ÂñÆ',
                medium: '‰∏≠Á≠â',
                hard: 'Âõ∞Èõ£',
                extreme: 'Ê•µÈôê',
                adaptive: 'Ëá™ÈÅ©Êáâ',
                menu: '‚ò∞',
                pause: '‚è∏Ô∏è Êö´ÂÅú',
                resume: '‚ñ∂Ô∏è ÁπºÁ∫å',
                replay: 'üîÑ ÈáçÊñ∞ÈñãÂßã',
                home: 'üè† È¶ñÈ†Å',
                startShuffle: 'ÈñãÂßãÊ¥óÁâå',
                focusMind: '"ÈõÜ‰∏≠‰Ω†ÁöÑÂøÉÁ•û„ÄÇ"',
                back: '¬´',
                turnWatch: 'P{n} ÁöÑÂõûÂêàÔºÅ',
                focus: 'P{n} ÈõÜ‰∏≠...',
                pickCup: 'P{n}ÔºåÈÅ∏Êìá‰Ω†ÁöÑÊùØÂ≠êÔºÅ',
                gotIt: 'P{n} ÁåúÂ∞ç‰∫ÜÔºÅ',
                missed: 'P{n} ÁåúÈåØ‰∫ÜÔºÅ',
                ready: 'P{n} ÁöÑÂõûÂêà„ÄÇÊ∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü',
                restart: 'ÈáçÊñ∞ÈñãÂßã',
                avatarLabel: 'È†≠ÂÉè',
                animals: 'ÂãïÁâ©',
                elements: 'ÂÖÉÁ¥†',
                anime: 'ÂãïÊº´',
                streak: 'ÈÄ£Âãù',
                highestStreak: 'ÊúÄÈ´ò'
            }
        };

        function setLanguage(lang) {
            state.language = lang;
            updateAllText();
            showScreen('player-screen');
        }

        function t(key, replacements = {}) {
            let text = translations[state.language][key] || translations['en'][key] || key;
            Object.keys(replacements).forEach(k => {
                text = text.replace(`{${k}}`, replacements[k]);
            });
            return text;
        }

        function updateAllText() {
            // Splash screen
            document.querySelector('#splash-screen h1').textContent = t('title');
            document.querySelector('#splash-screen .btn-gold').textContent = t('enterGame');
            
            // Language screen
            document.querySelector('#lang-screen .label-header').textContent = t('language');
            const langBtns = document.querySelectorAll('#lang-screen .btn-gold');
            langBtns[0].textContent = t('english');
            langBtns[1].textContent = t('chinese');
            
            // Player screen
            document.querySelector('#player-screen .label-header').textContent = t('selectPlayers');
            const playerBtns = document.querySelectorAll('#player-screen .btn-gold');
            playerBtns[0].textContent = t('solo');
            playerBtns[1].textContent = t('players2');
            playerBtns[2].textContent = t('players3');
            playerBtns[3].textContent = t('players4');

            // Name screen
            const nameScreenHeader = document.querySelector('#name-screen .label-header');
            if (nameScreenHeader) nameScreenHeader.textContent = t('enterNames');
            const nameLabels = document.querySelectorAll('.name-input-label');
            nameLabels.forEach((label, i) => {
                label.textContent = t('playerName', {n: i + 1});
            });
            const continueBtn = document.querySelector('#name-screen .btn-gold');
            if (continueBtn) continueBtn.textContent = t('continue');

            // Difficulty screen
            document.querySelector('#diff-screen .label-header').textContent = t('difficulty');
            const diffBtns = document.querySelectorAll('#diff-screen .btn-gold');
            diffBtns[0].textContent = t('easy');
            diffBtns[1].textContent = t('medium');
            diffBtns[2].textContent = t('hard');
            diffBtns[3].textContent = t('extreme');
            diffBtns[4].textContent = t('adaptive');
            
            // Game screen
            document.querySelector('.menu-trigger').textContent = t('menu');
            const menuBtns = document.querySelectorAll('#menuBar button');
            menuBtns[0].textContent = '‚è∏Ô∏è';
            menuBtns[1].textContent = '‚ñ∂Ô∏è';
            menuBtns[2].textContent = 'üîÑ';
            menuBtns[3].textContent = 'üè†';
            
            document.querySelector('#footer-start-btn').textContent = t('startShuffle');
            document.querySelector('#footer-restart-btn').textContent = t('restart');
            document.querySelector('#gemini-msg').textContent = t('focusMind');
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.textContent = t('back');
            });
        }

        function showScreen(id) {
            const currentScreen = document.querySelector('.screen.active');
            const nextScreen = document.getElementById(id);
            
            if (currentScreen) {
                // Add slide-out animation to current screen
                currentScreen.classList.add('slide-out-center');
                
                setTimeout(() => {
                    // Remove active class and animation class
                    currentScreen.classList.remove('active', 'slide-out-center');
                    
                    // Show next screen with slide-in animation
                    nextScreen.classList.add('active', 'slide-in-center');
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        nextScreen.classList.remove('slide-in-center');
                    }, 700);
                }, 500);
            } else {
                // First screen load, just show it
                nextScreen.classList.add('active', 'slide-in-center');
                setTimeout(() => {
                    nextScreen.classList.remove('slide-in-center');
                }, 700);
            }
        }

        function toggleMenu() {
            document.getElementById("menuBar").classList.toggle("show");
            document.getElementById("menuOverlay").classList.toggle("show");
        }

        function setPlayers(num) {
            state.playerCount = num;
            state.numCups = (num === 1) ? 3 : 4;
            state.difficultySelected = false;
            state.difficulty = null;
            setupNameInputs();
            showScreen('name-screen');
        }

        function setupNameInputs() {
            const container = document.getElementById('nameInputContainer');
            container.innerHTML = '';
            
            // Avatar sets by category
            const avatarSets = {
                animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ'],
                elements: ['üî•', 'üíß', 'üåä', '‚ö°', 'üí®', 'üå™Ô∏è', '‚ùÑÔ∏è', '‚≠ê', 'üåü', 'üíé', 'üåô', '‚òÄÔ∏è'],
                anime: ['üòÄ', 'üòé', 'ü§ì', 'üòá', 'ü•≥', 'ü§©', 'üò∫', 'ü§ñ', 'üëæ', 'üé≠', 'üé™', 'üé®']
            };
            
            // TOP - Shared Avatar Category Buttons
            const sharedAvatarSection = document.createElement('div');
            sharedAvatarSection.className = 'shared-avatar-section';
            
            const avatarLabel = document.createElement('div');
            avatarLabel.className = 'name-input-label';
            avatarLabel.textContent = t('avatarLabel');
            avatarLabel.style.textAlign = 'center';
            avatarLabel.style.marginBottom = '5px';
            
            const categoriesDiv = document.createElement('div');
            categoriesDiv.className = 'avatar-categories';
            
            const animalBtn = document.createElement('button');
            animalBtn.className = 'category-btn';
            animalBtn.textContent = t('animals');
            animalBtn.onclick = () => switchAvatarCategoryForAll('animals', avatarSets, animalBtn);
            
            const elementsBtn = document.createElement('button');
            elementsBtn.className = 'category-btn';
            elementsBtn.textContent = t('elements');
            elementsBtn.onclick = () => switchAvatarCategoryForAll('elements', avatarSets, elementsBtn);
            
            const animeBtn = document.createElement('button');
            animeBtn.className = 'category-btn';
            animeBtn.textContent = t('anime');
            animeBtn.onclick = () => switchAvatarCategoryForAll('anime', avatarSets, animeBtn);
            
            categoriesDiv.appendChild(animalBtn);
            categoriesDiv.appendChild(elementsBtn);
            categoriesDiv.appendChild(animeBtn);
            
            sharedAvatarSection.appendChild(avatarLabel);
            sharedAvatarSection.appendChild(categoriesDiv);
            
            // Create shared avatar selector container that appears below buttons
            const sharedSelectorContainer = document.createElement('div');
            sharedSelectorContainer.className = 'shared-avatar-selector-container';
            sharedSelectorContainer.id = 'shared-avatar-selector';
            sharedAvatarSection.appendChild(sharedSelectorContainer);
            
            // BOTTOM - All Players with back-plates
            const allPlayersSection = document.createElement('div');
            allPlayersSection.className = 'all-players-section';
            
            for (let i = 0; i < state.playerCount; i++) {
                // Create back-plate for each player
                const playerBackPlate = document.createElement('div');
                playerBackPlate.className = 'player-back-plate';
                
                const playerRow = document.createElement('div');
                playerRow.style.display = 'flex';
                playerRow.style.gap = '15px';
                playerRow.style.width = '100%';
                playerRow.style.alignItems = 'flex-start';
                
                // Name Input
                const nameSection = document.createElement('div');
                nameSection.style.flex = '1';
                nameSection.style.minWidth = '0';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'name-input-wrapper';
                
                const label = document.createElement('div');
                label.className = 'name-input-label';
                label.textContent = t('playerName', {n: i + 1});
                
                const row = document.createElement('div');
                row.className = 'name-input-row';
                
                const avatarDisplay = document.createElement('div');
                avatarDisplay.className = 'avatar-display';
                avatarDisplay.id = `avatar-display-${i}`;
                avatarDisplay.textContent = '?';
                
                const inputField = document.createElement('div');
                inputField.className = 'name-input-field';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'name-input';
                input.placeholder = t('playerPlaceholder', {n: i + 1});
                input.value = '';
                input.maxLength = 15;
                input.id = `player-name-${i}`;
                
                // Add input listener to check completion
                input.addEventListener('input', () => checkPlayerCompletion(i));
                
                inputField.appendChild(input);
                row.appendChild(avatarDisplay);
                row.appendChild(inputField);
                
                wrapper.appendChild(label);
                wrapper.appendChild(row);
                nameSection.appendChild(wrapper);
                
                playerRow.appendChild(nameSection);
                playerBackPlate.appendChild(playerRow);
                
                allPlayersSection.appendChild(playerBackPlate);
            }
            
            container.appendChild(sharedAvatarSection);
            container.appendChild(allPlayersSection);
        }

        function populateAvatars(playerIndex, avatars, selectorElement) {
            selectorElement.innerHTML = '';
            
            avatars.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                if (emoji === state.playerAvatars[playerIndex]) {
                    option.classList.add('selected');
                }
                option.textContent = emoji;
                option.onclick = () => selectAvatar(playerIndex, emoji, option);
                selectorElement.appendChild(option);
            });
        }

        function switchAvatarCategoryForAll(category, avatarSets, clickedBtn) {
            const categoriesDiv = clickedBtn.parentElement;
            const sharedContainer = document.getElementById('shared-avatar-selector');
            
            // Check if this button is already active (toggle behavior)
            const isAlreadyActive = clickedBtn.classList.contains('active');
            
            // Remove active class from all category buttons
            categoriesDiv.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // If it was already active, hide the selector and return
            if (isAlreadyActive) {
                sharedContainer.innerHTML = '';
                return;
            }
            
            // Add active class to clicked button
            clickedBtn.classList.add('active');
            
            // Get or create shared avatar selector
            sharedContainer.innerHTML = '';
            
            // Create ONE set of avatar options for all players to choose from
            const avatarSelector = document.createElement('div');
            avatarSelector.className = 'avatar-selector visible';
            
            avatarSets[category].forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.textContent = emoji;
                
                // When clicked, find which player is currently selecting (or assign to next player without avatar)
                option.onclick = () => {
                    // Find the first player without an avatar selected
                    let targetPlayer = -1;
                    for (let i = 0; i < state.playerCount; i++) {
                        const avatarDisplay = document.getElementById(`avatar-display-${i}`);
                        if (avatarDisplay.textContent === '?') {
                            targetPlayer = i;
                            break;
                        }
                    }
                    
                    // If all players have avatars, allow re-selection for player 1
                    if (targetPlayer === -1) {
                        targetPlayer = 0;
                    }
                    
                    selectAvatar(targetPlayer, emoji, option);
                };
                
                avatarSelector.appendChild(option);
            });
            
            sharedContainer.appendChild(avatarSelector);
        }

        function switchAvatarCategory(playerIndex, category, avatarSets, clickedBtn) {
            const selector = document.getElementById(`avatar-selector-${playerIndex}`);
            const categoriesDiv = clickedBtn.parentElement;
            
            // Remove active class from all category buttons
            categoriesDiv.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            clickedBtn.classList.add('active');
            
            // Show selector and populate avatars for selected category
            selector.classList.add('visible');
            populateAvatars(playerIndex, avatarSets[category], selector);
        }

        function selectAvatar(playerIndex, emoji, option) {
            state.playerAvatars[playerIndex] = emoji;
            document.getElementById(`avatar-display-${playerIndex}`).textContent = emoji;
            
            // Remove selected class from all options in this player's selector
            const selector = option.parentElement;
            selector.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            option.classList.add('selected');
            
            // Check if player completed their profile
            checkPlayerCompletion(playerIndex);
            
            // Hide the avatar selector after selection
            const sharedContainer = document.getElementById('shared-avatar-selector');
            if (sharedContainer) {
                sharedContainer.innerHTML = '';
            }
            
            // Remove active class from all category buttons
            const categoryButtons = document.querySelectorAll('.avatar-categories .category-btn');
            categoryButtons.forEach(btn => btn.classList.remove('active'));
        }

        function checkPlayerCompletion(playerIndex) {
            const nameInput = document.getElementById(`player-name-${playerIndex}`);
            const avatarDisplay = document.getElementById(`avatar-display-${playerIndex}`);
            const wrapper = nameInput.closest('.name-input-wrapper');
            
            const hasName = nameInput.value.trim().length > 0;
            const hasAvatar = avatarDisplay.textContent !== '?';
            
            if (hasName && hasAvatar) {
                wrapper.classList.add('completed');
                avatarDisplay.classList.add('completed');
            } else {
                wrapper.classList.remove('completed');
                avatarDisplay.classList.remove('completed');
            }
        }

        function submitNames() {
            let hasError = false;
            const continueBtn = document.querySelector('#name-screen .btn-gold');
            const nameContainer = document.getElementById('nameInputContainer');
            
            // Remove previous error states
            continueBtn.classList.remove('error-btn');
            nameContainer.classList.remove('shake');
            
            // Validate and get all player names
            for (let i = 0; i < state.playerCount; i++) {
                const input = document.getElementById(`player-name-${i}`);
                const name = input.value.trim();
                const hasAvatar = state.playerAvatars[i] !== undefined;
                
                // Remove previous error class
                input.classList.remove('error');
                
                // Validation: check if name is empty or no avatar selected
                if (name === '' || !hasAvatar) {
                    input.classList.add('error');
                    hasError = true;
                } else if (name.length > 15) {
                    input.classList.add('error');
                    hasError = true;
                } else {
                    state.playerNames[i] = name;
                }
            }
            
            // If there are errors, shake center content and turn button red
            if (hasError) {
                nameContainer.classList.add('shake');
                continueBtn.classList.add('error-btn');
                
                // Remove shake after animation completes
                setTimeout(() => {
                    nameContainer.classList.remove('shake');
                }, 500);
                
                return; // Don't proceed to next screen
            }
            
            // All validation passed, continue to next screen
            showScreen('diff-screen');
            updateDifficultyButtons();
        }

        function selectDifficulty(diff) {
            if (state.gameActive) return;
            state.difficulty = diff;
            state.difficultySelected = true;
            updateDifficultyButtons();
            // Initialize game and show game screen with slide effect
            setTimeout(() => {
                initGame();
            }, 300);
        }

        function updateDifficultyButtons() {
            const buttons = document.querySelectorAll('.diff-btn');
            buttons.forEach(btn => {
                const diff = btn.getAttribute('data-difficulty');
                if (diff === state.difficulty) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
                btn.disabled = state.gameActive;
            });
        }

        function initGame() {
            if (!state.difficulty) return;
            state.scores = [0,0,0,0];
            state.currentPlayer = 0;
            setupGameArea();
            updateScoreUI();
            updateDifficultyDisplay();
            showScreen('game-screen');
            resetBoard(true);
            document.getElementById('footer-start-btn').style.display = 'block';
        }

        function updateDifficultyDisplay() {
            const display = document.getElementById('diff-display');
            if (state.difficulty && difficultySettings[state.difficulty]) {
                const settings = difficultySettings[state.difficulty];
                display.innerHTML = `${t('difficultyLabel')}: <span>${settings.label}</span> - ${settings.desc}`;
            }
        }

        function updateScoreUI() {
            const container = document.getElementById('player-indicators');
            container.innerHTML = '';
            
            // Display player scores
            for(let i=0; i<state.playerCount; i++) {
                const div = document.createElement('div');
                div.className = `p-score ${i === state.currentPlayer ? 'active-turn' : ''}`;
                div.innerHTML = `${state.playerAvatars[i]} ${state.playerNames[i]}: <b>${state.scores[i]}</b>`;
                container.appendChild(div);
            }
            
            // Display streak in separate div
            const streakDisplay = document.getElementById('streak-display');
            if (streakDisplay) {
                streakDisplay.innerHTML = `üî• ${t('streak')}: <b>${state.consecutiveWins}</b> | üèÜ ${t('highestStreak')}: <b>${state.highestStreak}</b>`;
            }
        }

        function setupGameArea() {
            const area = document.getElementById('game-area');
            area.innerHTML = '';
            
            // Adjust gap based on number of cups
            if (state.numCups === 3) {
                area.style.gap = '130px';
            } else if (state.numCups === 4) {
                area.style.gap = '100px';
            }
            
            state.mapping = Array.from({length: state.numCups}, (_, i) => i);
            for (let i = 0; i < state.numCups; i++) {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`; slot.className = 'cup-slot';
                const ball = document.createElement('div');
                ball.className = 'ball';
                slot.appendChild(ball);
                const cup = document.createElement('div');
                cup.className = 'cup'; cup.onclick = () => checkWin(i);
                cup.hasBall = false;
                slot.appendChild(cup);
                area.appendChild(slot);
            }
        }

        function handlePause() {
            if (!state.gameActive) return;
            state.isPaused = true;
            document.getElementById('menu-pause-btn').style.display = 'none';
            document.getElementById('menu-resume-btn').style.display = 'block';
            // Keep menu open so user can resume
        }

        function handleResume() {
            if (!state.gameActive) return;
            state.isPaused = false;
            document.getElementById('menu-pause-btn').style.display = 'block';
            document.getElementById('menu-resume-btn').style.display = 'none';
            toggleMenu(); // Close menu when resuming
        }

        function handleRestart() {
            // Instant reset - close menu and reset everything immediately
            const menuBar = document.getElementById("menuBar");
            const menuOverlay = document.getElementById("menuOverlay");
            menuBar.classList.remove("show");
            menuOverlay.classList.remove("show");
            
            // Reset pause button state
            document.getElementById('menu-pause-btn').style.display = 'block';
            document.getElementById('menu-resume-btn').style.display = 'none';
            
            // Instant reset
            state.gameActive = false;
            state.isPaused = false;
            state.isBusy = false;
            state.scores = [0,0,0,0];
            state.currentPlayer = 0;
            state.mapping = Array.from({length: state.numCups}, (_, i) => i);
            
            // Reset UI instantly
            updateScoreUI();
            document.querySelectorAll('.cup-slot').forEach(el => el.style.transform = `translateX(0px)`);
            document.querySelectorAll('.cup').forEach(c => {
                c.classList.remove('lift');
                c.classList.remove('lift-high');
            });
            const ball = document.getElementById('ball');
            if (ball) ball.classList.remove('visible');
            document.getElementById('footer-start-btn').style.display = 'block';
            document.getElementById('gemini-msg').innerText = t('turnWatch', {n: 1});
        }

        function handleHome() {
            // Close menu first
            const menuBar = document.getElementById("menuBar");
            const menuOverlay = document.getElementById("menuOverlay");
            menuBar.classList.remove("show");
            menuOverlay.classList.remove("show");
            
            // Reset everything and go home
            state.gameActive = false;
            state.isPaused = false;
            state.isBusy = false;
            state.difficulty = null;
            state.difficultySelected = false;
            state.scores = [0,0,0,0];
            state.currentPlayer = 0;
            
            // Reset pause button state
            document.getElementById('menu-pause-btn').style.display = 'block';
            document.getElementById('menu-resume-btn').style.display = 'none';
            
            showScreen('splash-screen');
        }

        function resetBoard(hardReset = false, showStartButton = true) {
            state.gameActive = false;
            state.isPaused = false;
            state.isBusy = false;
            state.mapping = Array.from({length: state.numCups}, (_, i) => i);
            
            // Reset pause button state
            document.getElementById('menu-pause-btn').style.display = 'block';
            document.getElementById('menu-resume-btn').style.display = 'none';
            
            if(hardReset) { 
                state.scores = [0,0,0,0];
                state.currentPlayer = 0; 
                updateScoreUI();
                document.getElementById('gemini-msg').innerText = t('turnWatch', {n: 1});
            }
            
            document.querySelectorAll('.cup-slot').forEach(el => el.style.transform = `translateX(0px)`);
            document.querySelectorAll('.cup').forEach(c => {
                c.classList.remove('lift');
                c.classList.remove('lift-high');
            });
            document.querySelectorAll('.ball').forEach(b => {
                b.classList.remove('visible');
            });
            
            // Only show start button if explicitly requested (e.g., after game over)
            if (showStartButton) {
                document.getElementById('footer-start-btn').style.display = 'block';
            } else {
                document.getElementById('footer-start-btn').style.display = 'none';
            }
            
            const menuBar = document.getElementById("menuBar");
            const menuOverlay = document.getElementById("menuOverlay");
            if (menuBar && menuBar.classList.contains("show")) {
                menuBar.classList.remove("show");
                menuOverlay.classList.remove("show");
            }
        }

        function goHome() { 
            resetBoard(true); 
            state.difficulty = null;
            state.difficultySelected = false;
            showScreen('splash-screen'); 
        }

        async function playGame() {
            if(state.isBusy) return;
            state.isBusy = true; state.gameActive = true;
            document.getElementById('footer-start-btn').style.display = 'none';
            document.getElementById('gemini-msg').innerText = getRandomGeminiMessage();
            
            const cups = document.querySelectorAll('.cup');
            const slots = document.querySelectorAll('.cup-slot');
            
            // Randomize starting cup
            const randomCupIndex = Math.floor(Math.random() * state.numCups);
            cups.forEach(cup => cup.hasBall = false);
            cups[randomCupIndex].hasBall = true;
            
            // Get the ball inside the random slot
            const randomSlot = slots[randomCupIndex];
            const ball = randomSlot.querySelector('.ball');
            
            // Step 1: Show ball clearly
            ball.classList.add('visible');
            await new Promise(r => setTimeout(r, 800));
            
            // Step 2: Lift the cup to show the ball is under it
            cups[randomCupIndex].classList.add('lift-high');
            await new Promise(r => setTimeout(r, 1500));
            
            // Step 3: Put the cup back down
            cups[randomCupIndex].classList.remove('lift-high');
            await new Promise(r => setTimeout(r, 600));
            
            // Step 4: Hide ball before shuffling starts
            ball.classList.remove('visible');
            await new Promise(r => setTimeout(r, 400));

            // Get difficulty settings
            const settings = difficultySettings[state.difficulty] || difficultySettings.medium;
            const rounds = settings.rounds;
            const shuffleInterval = settings.interval;
            const complexMoveChance = settings.complexChance;
            const ballFocusChance = settings.ballChance;

            // Track recent swaps to avoid repetitive patterns
            let recentSwaps = [];
            const maxRecentSwaps = 3;

            for(let i=0; i < rounds; i++) {
                while(state.isPaused) await new Promise(r => setTimeout(r, 100));
                
                // Decide if this should be a complex move
                if (Math.random() < complexMoveChance && state.numCups >= 3) {
                    await performComplexMove(shuffleInterval, recentSwaps);
                } else {
                    await performSwap(shuffleInterval, recentSwaps, ballFocusChance);
                }
                
                await new Promise(r => setTimeout(r, 50));
            }
            state.isBusy = false;
            document.getElementById('gemini-msg').innerText = t('pickCup', {n: state.currentPlayer + 1});
        }

        async function performSwap(interval, recentSwaps = [], ballFocusChance = 0.5) {
            let pA, pB;
            let attempts = 0;
            const maxAttempts = 20;
            
            // Find which visual position has the ball by checking the slots via mapping
            let ballPos = -1;
            for (let visualPos = 0; visualPos < state.numCups; visualPos++) {
                const slotId = state.mapping[visualPos];
                const slot = document.getElementById(`slot-${slotId}`);
                const cup = slot.querySelector('.cup');
                if (cup.hasBall) {
                    ballPos = visualPos;
                    break;
                }
            }
            
            // Higher difficulty increases chance of moving the ball cup
            if (Math.random() < ballFocusChance && ballPos !== -1) {
                // Pick the ball cup as one of the positions
                pA = ballPos;
                pB = Math.floor(Math.random() * state.numCups);
                while (pB === pA) pB = Math.floor(Math.random() * state.numCups);
            } else {
                // Pick two random positions, avoid recent patterns
                do {
                    pA = Math.floor(Math.random() * state.numCups);
                    pB = Math.floor(Math.random() * state.numCups);
                    while (pA === pB) pB = Math.floor(Math.random() * state.numCups);
                    
                    // Check if this swap was done recently
                    const swapKey = [Math.min(pA, pB), Math.max(pA, pB)].join('-');
                    const isRecent = recentSwaps.includes(swapKey);
                    
                    if (!isRecent || attempts >= maxAttempts) break;
                    attempts++;
                } while (attempts < maxAttempts);
            }
            
            // Track this swap
            const swapKey = [Math.min(pA, pB), Math.max(pA, pB)].join('-');
            recentSwaps.push(swapKey);
            if (recentSwaps.length > 3) recentSwaps.shift();
            
            const idA = state.mapping[pA], idB = state.mapping[pB];
            const elA = document.getElementById(`slot-${idA}`), elB = document.getElementById(`slot-${idB}`);
            
            const animSpeed = interval * 0.95;
            elA.style.transitionDuration = `${animSpeed}ms`;
            elB.style.transitionDuration = `${animSpeed}ms`;

            const dist = elB.getBoundingClientRect().left - elA.getBoundingClientRect().left;
            const matA = new WebKitCSSMatrix(window.getComputedStyle(elA).transform), matB = new WebKitCSSMatrix(window.getComputedStyle(elB).transform);
            
            elA.style.transform = `translateX(${matA.m41 + dist}px)`; 
            elB.style.transform = `translateX(${matB.m41 - dist}px)`;
            
            // The hasBall property stays with the cup element (which is inside the slot)
            // No need to swap hasBall because the slot and its cup move together
            // The cup.hasBall property naturally follows the physical cup element
            
            state.mapping[pA] = idB; state.mapping[pB] = idA;

            await new Promise(r => setTimeout(r, interval));
        }

        async function performComplexMove(interval, recentSwaps = []) {
            // Complex moves: 3-way rotation, or rapid double-swap
            const moveType = Math.random();
            
            if (moveType < 0.5 && state.numCups >= 3) {
                // 3-way rotation (A -> B -> C -> A)
                let positions = [];
                while (positions.length < 3) {
                    const pos = Math.floor(Math.random() * state.numCups);
                    if (!positions.includes(pos)) positions.push(pos);
                }
                
                const [p1, p2, p3] = positions;
                const id1 = state.mapping[p1], id2 = state.mapping[p2], id3 = state.mapping[p3];
                const el1 = document.getElementById(`slot-${id1}`);
                const el2 = document.getElementById(`slot-${id2}`);
                const el3 = document.getElementById(`slot-${id3}`);
                
                const animSpeed = interval * 1.2;
                el1.style.transitionDuration = `${animSpeed}ms`;
                el2.style.transitionDuration = `${animSpeed}ms`;
                el3.style.transitionDuration = `${animSpeed}ms`;
                
                const mat1 = new WebKitCSSMatrix(window.getComputedStyle(el1).transform);
                const mat2 = new WebKitCSSMatrix(window.getComputedStyle(el2).transform);
                const mat3 = new WebKitCSSMatrix(window.getComputedStyle(el3).transform);
                
                const pos1 = el1.getBoundingClientRect().left;
                const pos2 = el2.getBoundingClientRect().left;
                const pos3 = el3.getBoundingClientRect().left;
                
                // Rotate: 1->2, 2->3, 3->1
                el1.style.transform = `translateX(${mat1.m41 + (pos2 - pos1)}px)`;
                el2.style.transform = `translateX(${mat2.m41 + (pos3 - pos2)}px)`;
                el3.style.transform = `translateX(${mat3.m41 + (pos1 - pos3)}px)`;
                
                state.mapping[p1] = id3;
                state.mapping[p2] = id1;
                state.mapping[p3] = id2;
                
                await new Promise(r => setTimeout(r, interval * 1.2));
                
            } else {
                // Double swap: swap two pairs quickly
                await performSwap(interval * 0.7, recentSwaps, 0.6);
                await new Promise(r => setTimeout(r, interval * 0.2));
                await performSwap(interval * 0.7, recentSwaps, 0.6);
            }
        }

        function checkWin(idx) {
            if(state.isBusy || state.isPaused || !state.gameActive) return;
            state.isBusy = true;
            document.querySelectorAll('.cup').forEach(c => c.classList.add('lift'));
            
            const cups = document.querySelectorAll('.cup');
            const slots = document.querySelectorAll('.cup-slot');
            
            // Show the ball in the cup that has it
            cups.forEach((cup, i) => {
                if (cup.hasBall) {
                    slots[i].querySelector('.ball').classList.add('visible');
                }
            });
            
            const clickedCup = cups[idx];
            
            if(clickedCup.hasBall) {
                // Correct guess - award point and continue playing
                state.consecutiveWins++;
                
                // Update highest streak if current streak is higher
                if (state.consecutiveWins > state.highestStreak) {
                    state.highestStreak = state.consecutiveWins;
                }
                
                // Award point
                state.scores[state.currentPlayer] += 1;
                
                document.getElementById('gemini-msg').innerText = getRandomGeminiMessage();
                
                // Move to next player in multiplayer mode
                if(state.playerCount > 1) {
                    state.currentPlayer = (state.currentPlayer + 1) % state.playerCount;
                }
                
                setTimeout(() => { 
                    updateScoreUI();
                    resetBoard(false, false); // Don't show start button during continuous play
                    // Auto-start next shuffle to keep game continuous on correct guess
                    setTimeout(() => {
                        playGame();
                    }, 800);
                }, 1500);
            } else {
                // Incorrect guess - move to next player and continue
                document.getElementById('gemini-msg').innerText = t('missed', {n: state.currentPlayer + 1});
                
                // Move to next player in multiplayer mode, or restart in solo
                if(state.playerCount > 1) {
                    state.currentPlayer = (state.currentPlayer + 1) % state.playerCount;
                    
                    setTimeout(() => { 
                        updateScoreUI();
                        resetBoard(false, false); // Don't show start button during continuous play
                        // Auto-start next player's turn
                        setTimeout(() => {
                            playGame();
                        }, 800);
                    }, 1500);
                } else {
                    // Solo mode - game over on miss
                    state.consecutiveWins = 0;
                    
                    setTimeout(() => { 
                        // Reset to first player and clear scores
                        state.scores = [0,0,0,0];
                        state.currentPlayer = 0;
                        updateScoreUI();
                        resetBoard(false, false); // Don't show start button yet
                        // Show restart button instead
                        document.getElementById('footer-restart-btn').style.display = 'block';
                        document.getElementById('gemini-msg').innerText = 'Game Over! Click Restart to try again.';
                    }, 2000);
                }
            }
        }

        function restartAfterFail() {
            const restartBtn = document.getElementById('footer-restart-btn');
            const startBtn = document.getElementById('footer-start-btn');
            const gameArea = document.getElementById('game-area');
            const gameDashboard = document.querySelector('.game-dashboard');
            
            // Add zoom-out effect to game area and dashboard
            gameArea.classList.add('zoom-out-center');
            gameDashboard.classList.add('zoom-out-center');
            restartBtn.style.opacity = '0';
            restartBtn.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                // Remove zoom-out and reset
                gameArea.classList.remove('zoom-out-center');
                gameDashboard.classList.remove('zoom-out-center');
                
                restartBtn.style.display = 'none';
                restartBtn.style.opacity = '1';
                restartBtn.style.transition = '';
                
                // Zoom in the game area and dashboard from center
                gameArea.classList.add('zoom-in-center');
                gameDashboard.classList.add('zoom-in-center');
                
                // Show start shuffle button with zooming effect
                startBtn.style.display = 'block';
                startBtn.classList.add('zoom-in-center');
                
                // Remove animation classes after they complete
                setTimeout(() => {
                    startBtn.classList.remove('zoom-in-center');
                    gameArea.classList.remove('zoom-in-center');
                    gameDashboard.classList.remove('zoom-in-center');
                }, 700);
                
                document.getElementById('gemini-msg').innerText = t('ready', {n: 1});
            }, 500);
        }
    </script>
</body>
</html>